FROM python:3.10-slim-bookworm AS base

# Install system dependencies (code-server, supervisor, etc.)
RUN apt-get update && apt-get install --no-install-recommends -y \
        build-essential \
        git \
        libportaudio2 \
        pandoc \
        curl \
        wget \
        ca-certificates \
        supervisor \
        dumb-init \
        locales \
    && sed -i "s/# en_US.UTF-8/en_US.UTF-8/" /etc/locale.gen \
    && locale-gen \
    && useradd -m -u 1000 -s /bin/bash coder \
    && rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8

# Install code-server
ARG CODE_SERVER_VERSION=4.20.0
RUN curl -fsSL https://code-server.dev/install.sh | sh -s -- --version=${CODE_SERVER_VERSION}

# Install Supabase CLI (works for all architectures)
RUN curl -fsSL https://supabase.com/cli/install.sh | sh

WORKDIR /workspace

# Setup venv, dirs, and permissions
RUN python -m venv /venv && \
    mkdir -p /home/coder/.aider/cache /home/coder/.cache \
             /home/coder/pw-browsers /home/coder/.config \
             /home/coder/.local /home/coder/.ollama \
             /workspace \
    && chown -R coder:coder /home/coder /workspace /venv \
    && chmod -R 777 /home/coder/.aider /home/coder/.cache /home/coder/pw-browsers /home/coder/.ollama \
    && git config --system --add safe.directory /workspace

# Env vars
ENV PATH="/venv/bin:$PATH" \
    PLAYWRIGHT_BROWSERS_PATH=/home/coder/pw-browsers \
    PLAYWRIGHT_SKIP_BROWSER_GC=1 \
    HOME=/home/coder \
    OLLAMA_HOST=0.0.0.0:11434 \
    OLLAMA_MODELS=/home/coder/.ollama/models \
    OLLAMA_VISION_MODEL=llama3.2-vision

#########################
FROM base AS aider-vscode

ENV AIDER_DOCKER_IMAGE=aider-vscode

# Copy source + config
COPY --chown=coder:coder . /tmp/aider
COPY --chown=coder:coder docker/start-services.sh /usr/local/bin/start-services.sh
COPY --chown=coder:coder docker/start_aider_api_docker.py /usr/local/bin/start_aider_api.py
COPY --chown=coder:coder docker/preload-vision-model.sh /usr/local/bin/preload-vision-model.sh
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Copy pre-built VS Code extension (should be built before docker build)
# Build it with: cd vscode-extension && npm install && npm run compile && npm run package
COPY --chown=coder:coder vscode-extension/aider-vscode-*.vsix /tmp/aider-vscode.vsix

# Install Python deps
RUN /venv/bin/python -m pip install --upgrade --no-cache-dir pip && \
    /venv/bin/python -m pip install --no-cache-dir \
        boto3 flask flask-cors \
        --extra-index-url https://download.pytorch.org/whl/cpu && \
    find /venv/lib/python3.10/site-packages \( -type d -exec chmod a+rwx {} + \) -o \( -type f -exec chmod a+rw {} + \) && \
    chmod +x /usr/local/bin/start-services.sh /usr/local/bin/start_aider_api.py /usr/local/bin/preload-vision-model.sh && \
    rm -rf /tmp/aider

USER coder

# Configure code-server and install extension
RUN mkdir -p /home/coder/.config/code-server /home/coder/.local/share/code-server/extensions && \
    printf "bind-addr: 0.0.0.0:8443\nauth: password\ncert: false\n" > /home/coder/.config/code-server/config.yaml && \
    code-server --install-extension /tmp/aider-vscode.vsix

EXPOSE 8443 5000 11434

ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["/usr/local/bin/start-services.sh"]